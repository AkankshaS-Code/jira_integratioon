name: Test All JIRA Operations

on:
  workflow_dispatch:

jobs:
  test-operations:
    runs-on: ubuntu-latest
    steps:
      - name: 1ï¸âƒ£ Update Ticket Status
        run: |
          echo "ğŸ”„ Testing: Update ticket status..."
          
          # Get transitions for SCRUM-3
          TRANSITIONS=$(curl -s -X GET \
            "https://api.atlassian.com/ex/jira/${{ secrets.ATLASSIAN_CLOUD_ID }}/rest/api/3/issue/SCRUM-3/transitions" \
            -H "Authorization: Bearer ${{ secrets.ATLASSIAN_ACCESS_TOKEN }}")
          
          echo "Available transitions:"
          echo "$TRANSITIONS" | jq '.transitions[] | {id: .id, name: .name}'
          
          # Get first transition
          TRANS_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[0].id')
          
          if [ ! -z "$TRANS_ID" ] && [ "$TRANS_ID" != "null" ]; then
            curl -s -X POST \
              "https://api.atlassian.com/ex/jira/${{ secrets.ATLASSIAN_CLOUD_ID }}/rest/api/3/issue/SCRUM-3/transitions" \
              -H "Authorization: Bearer ${{ secrets.ATLASSIAN_ACCESS_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"transition": {"id": "'"$TRANS_ID"'"}}'
            
            echo "âœ… Updated ticket status!"
          fi

      - name: 2ï¸âƒ£ Add Comment
        run: |
          echo "ğŸ’¬ Testing: Add comment to ticket..."
          
          curl -s -X POST \
            "https://api.atlassian.com/ex/jira/${{ secrets.ATLASSIAN_CLOUD_ID }}/rest/api/3/issue/SCRUM-3/comment" \
            -H "Authorization: Bearer ${{ secrets.ATLASSIAN_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "body": {
                "type": "doc",
                "version": 1,
                "content": [{
                  "type": "paragraph",
                  "content": [{
                    "type": "text",
                    "text": "âœ… Automated comment via OAuth 2.0 - Testing all JIRA operations at '"$(date)"'"
                  }]
                }]
              }
            }'
          
          echo "âœ… Added comment!"

      - name: 3ï¸âƒ£ Query Tickets
        run: |
          echo "ğŸ” Testing: Query tickets..."
          
          RESULTS=$(curl -s -X GET \
            "https://api.atlassian.com/ex/jira/${{ secrets.ATLASSIAN_CLOUD_ID }}/rest/api/3/search?jql=project=SCRUM&maxResults=10" \
            -H "Authorization: Bearer ${{ secrets.ATLASSIAN_ACCESS_TOKEN }}")
          
          echo "Recent SCRUM tickets:"
          echo "$RESULTS" | jq -r '.issues[] | "âœ… \(.key): \(.fields.summary) [\(.fields.status.name)]"'

      - name: 4ï¸âƒ£ Update Ticket Field
        run: |
          echo "ğŸ“ Testing: Update ticket fields..."
          
          curl -s -X PUT \
            "https://api.atlassian.com/ex/jira/${{ secrets.ATLASSIAN_CLOUD_ID }}/rest/api/3/issue/SCRUM-3" \
            -H "Authorization: Bearer ${{ secrets.ATLASSIAN_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "fields": {
                "labels": ["oauth-test", "automated"]
              }
            }'
          
          echo "âœ… Updated ticket labels!"

      - name: ğŸ“Š Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL JIRA OPERATIONS TESTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Authentication: OAuth 2.0 (App-Based)"
          echo ""
          echo "Operations Tested:"
          echo "  âœ… Create Ticket (Trivy workflow)"
          echo "  âœ… Update Status"
          echo "  âœ… Add Comment"
          echo "  âœ… Query Tickets"
          echo "  âœ… Update Fields"
          echo ""
          echo "ğŸ‰ Complete JIRA automation demonstrated!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
